{"ast":null,"code":"var __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) {\n      ar.push(r.value);\n    }\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) {\n    ar = ar.concat(__read(arguments[i]));\n  }\n\n  return ar;\n};\n\nimport { useRef, useCallback, useMemo, useEffect, useState } from 'react';\nimport useAsync from './useAsync';\nimport useUpdateEffect from './utils/useUpdateEffect';\n\nfunction useLoadMore(service, options) {\n  var _a = options.refreshDeps,\n      refreshDeps = _a === void 0 ? [] : _a,\n      ref = options.ref,\n      isNoMore = options.isNoMore,\n      _b = options.threshold,\n      threshold = _b === void 0 ? 100 : _b,\n      fetchKey = options.fetchKey,\n      restOptions = __rest(options, [\"refreshDeps\", \"ref\", \"isNoMore\", \"threshold\", \"fetchKey\"]);\n\n  var _c = __read(useState(false), 2),\n      loadingMore = _c[0],\n      setLoadingMore = _c[1];\n\n  useEffect(function () {\n    if (options.fetchKey) {\n      console.warn(\"useRequest loadMore mode don't need fetchKey!\");\n    }\n  }, []);\n  var result = useAsync(service, __assign(__assign({}, restOptions), {\n    fetchKey: function fetchKey(d) {\n      var _a;\n\n      return ((_a = d === null || d === void 0 ? void 0 : d.list) === null || _a === void 0 ? void 0 : _a.length) || 0;\n    },\n    onSuccess: function onSuccess() {\n      var params = [];\n\n      for (var _i = 0; _i < arguments.length; _i++) {\n        params[_i] = arguments[_i];\n      }\n\n      setLoadingMore(false);\n\n      if (options.onSuccess) {\n        options.onSuccess.apply(options, __spread(params));\n      }\n    }\n  }));\n  var data = result.data,\n      run = result.run,\n      params = result.params,\n      reset = result.reset,\n      loading = result.loading,\n      fetches = result.fetches;\n  var reload = useCallback(function () {\n    reset();\n\n    var _a = __read(params),\n        restParams = _a.slice(1);\n\n    run.apply(void 0, __spread([undefined], restParams));\n  }, [run, reset, params]);\n  var reloadRef = useRef(reload);\n  reloadRef.current = reload;\n  /* loadMore 场景下，如果 refreshDeps 变化，重置到第一页 */\n\n  useUpdateEffect(function () {\n    /* 只有自动执行的场景， refreshDeps 才有效 */\n    if (!options.manual) {\n      reloadRef.current();\n    }\n  }, __spread(refreshDeps));\n  var dataGroup = useMemo(function () {\n    var listGroup = []; // 在 loadMore 时，不希望清空上一次的 data。需要把最后一个 非 loading 的请求 data，放回去。\n\n    var lastNoLoadingData = data;\n    Object.values(fetches).forEach(function (h) {\n      var _a, _b;\n\n      if ((_a = h.data) === null || _a === void 0 ? void 0 : _a.list) {\n        listGroup = listGroup.concat((_b = h.data) === null || _b === void 0 ? void 0 : _b.list);\n      }\n\n      if (!h.loading) {\n        lastNoLoadingData = h.data;\n      }\n    });\n    return __assign(__assign({}, lastNoLoadingData), {\n      list: listGroup\n    });\n  }, [fetches, data]);\n  var noMore = isNoMore ? !loading && !loadingMore && isNoMore(dataGroup) : false;\n  var loadMore = useCallback(function () {\n    if (noMore) {\n      return;\n    }\n\n    setLoadingMore(true);\n\n    var _a = __read(params),\n        restParams = _a.slice(1);\n\n    run.apply(void 0, __spread([dataGroup], restParams));\n  }, [noMore, run, dataGroup, params]);\n  /* 上拉加载的方法 */\n\n  var scrollMethod = function scrollMethod() {\n    if (loading || loadingMore || !ref || !ref.current) {\n      return;\n    }\n\n    if (ref.current.scrollHeight - ref.current.scrollTop <= ref.current.clientHeight + threshold) {\n      loadMore();\n    }\n  }; // 如果不用 ref，而用之前的 useCallbak，在某些情况下会出问题，造成拿到的 loading 不是最新的。\n  // fix https://github.com/alibaba/hooks/issues/630\n\n\n  var scrollMethodRef = useRef(scrollMethod);\n  scrollMethodRef.current = scrollMethod;\n  /* 如果有 ref，则会上拉加载更多 */\n\n  useEffect(function () {\n    if (!ref || !ref.current) {\n      return function () {};\n    }\n\n    var scrollTrigger = function scrollTrigger() {\n      return scrollMethodRef.current();\n    };\n\n    ref.current.addEventListener('scroll', scrollTrigger);\n    return function () {\n      if (ref && ref.current) {\n        ref.current.removeEventListener('scroll', scrollTrigger);\n      }\n    };\n  }, [scrollMethodRef]);\n  return __assign(__assign({}, result), {\n    data: dataGroup,\n    reload: reload,\n    loading: loading && dataGroup.list.length === 0,\n    loadMore: loadMore,\n    loadingMore: loadingMore,\n    noMore: noMore\n  });\n}\n\nexport default useLoadMore;","map":{"version":3,"sources":["/Users/brandonliu/Project/goairmart/antd-demo/node_modules/@ahooksjs/use-request/es/useLoadMore.js"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__rest","e","indexOf","getOwnPropertySymbols","propertyIsEnumerable","__read","o","m","Symbol","iterator","r","ar","next","done","push","value","error","__spread","concat","useRef","useCallback","useMemo","useEffect","useState","useAsync","useUpdateEffect","useLoadMore","service","options","_a","refreshDeps","ref","isNoMore","_b","threshold","fetchKey","restOptions","_c","loadingMore","setLoadingMore","console","warn","result","d","list","onSuccess","params","_i","data","run","reset","loading","fetches","reload","restParams","slice","undefined","reloadRef","current","manual","dataGroup","listGroup","lastNoLoadingData","values","forEach","h","noMore","loadMore","scrollMethod","scrollHeight","scrollTop","clientHeight","scrollMethodRef","scrollTrigger","addEventListener","removeEventListener"],"mappings":"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","sourcesContent":["var __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) {\n      ar.push(r.value);\n    }\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) {\n    ar = ar.concat(__read(arguments[i]));\n  }\n\n  return ar;\n};\n\nimport { useRef, useCallback, useMemo, useEffect, useState } from 'react';\nimport useAsync from './useAsync';\nimport useUpdateEffect from './utils/useUpdateEffect';\n\nfunction useLoadMore(service, options) {\n  var _a = options.refreshDeps,\n      refreshDeps = _a === void 0 ? [] : _a,\n      ref = options.ref,\n      isNoMore = options.isNoMore,\n      _b = options.threshold,\n      threshold = _b === void 0 ? 100 : _b,\n      fetchKey = options.fetchKey,\n      restOptions = __rest(options, [\"refreshDeps\", \"ref\", \"isNoMore\", \"threshold\", \"fetchKey\"]);\n\n  var _c = __read(useState(false), 2),\n      loadingMore = _c[0],\n      setLoadingMore = _c[1];\n\n  useEffect(function () {\n    if (options.fetchKey) {\n      console.warn(\"useRequest loadMore mode don't need fetchKey!\");\n    }\n  }, []);\n  var result = useAsync(service, __assign(__assign({}, restOptions), {\n    fetchKey: function fetchKey(d) {\n      var _a;\n\n      return ((_a = d === null || d === void 0 ? void 0 : d.list) === null || _a === void 0 ? void 0 : _a.length) || 0;\n    },\n    onSuccess: function onSuccess() {\n      var params = [];\n\n      for (var _i = 0; _i < arguments.length; _i++) {\n        params[_i] = arguments[_i];\n      }\n\n      setLoadingMore(false);\n\n      if (options.onSuccess) {\n        options.onSuccess.apply(options, __spread(params));\n      }\n    }\n  }));\n  var data = result.data,\n      run = result.run,\n      params = result.params,\n      reset = result.reset,\n      loading = result.loading,\n      fetches = result.fetches;\n  var reload = useCallback(function () {\n    reset();\n\n    var _a = __read(params),\n        restParams = _a.slice(1);\n\n    run.apply(void 0, __spread([undefined], restParams));\n  }, [run, reset, params]);\n  var reloadRef = useRef(reload);\n  reloadRef.current = reload;\n  /* loadMore 场景下，如果 refreshDeps 变化，重置到第一页 */\n\n  useUpdateEffect(function () {\n    /* 只有自动执行的场景， refreshDeps 才有效 */\n    if (!options.manual) {\n      reloadRef.current();\n    }\n  }, __spread(refreshDeps));\n  var dataGroup = useMemo(function () {\n    var listGroup = []; // 在 loadMore 时，不希望清空上一次的 data。需要把最后一个 非 loading 的请求 data，放回去。\n\n    var lastNoLoadingData = data;\n    Object.values(fetches).forEach(function (h) {\n      var _a, _b;\n\n      if ((_a = h.data) === null || _a === void 0 ? void 0 : _a.list) {\n        listGroup = listGroup.concat((_b = h.data) === null || _b === void 0 ? void 0 : _b.list);\n      }\n\n      if (!h.loading) {\n        lastNoLoadingData = h.data;\n      }\n    });\n    return __assign(__assign({}, lastNoLoadingData), {\n      list: listGroup\n    });\n  }, [fetches, data]);\n  var noMore = isNoMore ? !loading && !loadingMore && isNoMore(dataGroup) : false;\n  var loadMore = useCallback(function () {\n    if (noMore) {\n      return;\n    }\n\n    setLoadingMore(true);\n\n    var _a = __read(params),\n        restParams = _a.slice(1);\n\n    run.apply(void 0, __spread([dataGroup], restParams));\n  }, [noMore, run, dataGroup, params]);\n  /* 上拉加载的方法 */\n\n  var scrollMethod = function scrollMethod() {\n    if (loading || loadingMore || !ref || !ref.current) {\n      return;\n    }\n\n    if (ref.current.scrollHeight - ref.current.scrollTop <= ref.current.clientHeight + threshold) {\n      loadMore();\n    }\n  }; // 如果不用 ref，而用之前的 useCallbak，在某些情况下会出问题，造成拿到的 loading 不是最新的。\n  // fix https://github.com/alibaba/hooks/issues/630\n\n\n  var scrollMethodRef = useRef(scrollMethod);\n  scrollMethodRef.current = scrollMethod;\n  /* 如果有 ref，则会上拉加载更多 */\n\n  useEffect(function () {\n    if (!ref || !ref.current) {\n      return function () {};\n    }\n\n    var scrollTrigger = function scrollTrigger() {\n      return scrollMethodRef.current();\n    };\n\n    ref.current.addEventListener('scroll', scrollTrigger);\n    return function () {\n      if (ref && ref.current) {\n        ref.current.removeEventListener('scroll', scrollTrigger);\n      }\n    };\n  }, [scrollMethodRef]);\n  return __assign(__assign({}, result), {\n    data: dataGroup,\n    reload: reload,\n    loading: loading && dataGroup.list.length === 0,\n    loadMore: loadMore,\n    loadingMore: loadingMore,\n    noMore: noMore\n  });\n}\n\nexport default useLoadMore;"]},"metadata":{},"sourceType":"module"}