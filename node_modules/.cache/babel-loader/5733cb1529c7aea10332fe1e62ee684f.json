{"ast":null,"code":"import _regeneratorRuntime from \"/Users/brandonliu/Project/goairmart/antd-demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport React, { useLayoutEffect, useRef, useState } from 'react';\nimport { AddOutline } from 'antd-mobile-icons';\nimport { mergeProps } from '../../utils/with-default-props';\nimport ImageViewer from '../image-viewer';\nimport PreviewItem from './preview-item';\nimport { usePropsValue } from '../../utils/use-props-value';\nimport { usePersistFn } from 'ahooks';\nimport Space from '../space';\nimport { withNativeProps } from '../../utils/native-props';\nvar classPrefix = \"adm-image-uploader\";\nvar defaultProps = {\n  disableUpload: false,\n  deletable: true,\n  showUpload: true,\n  multiple: false,\n  maxCount: 0,\n  defaultValue: [],\n  accept: 'image/*'\n};\nexport var ImageUploader = function ImageUploader(p) {\n  var props = mergeProps(defaultProps, p);\n\n  var _usePropsValue = usePropsValue(props),\n      value = _usePropsValue[0],\n      setValue = _usePropsValue[1];\n\n  var updateValue = usePersistFn(function (updater) {\n    setValue(updater(value));\n  });\n\n  var _useState = useState([]),\n      tasks = _useState[0],\n      setTasks = _useState[1];\n\n  useLayoutEffect(function () {\n    setTasks(function (prev) {\n      return prev.filter(function (task) {\n        if (task.url === undefined) return true;\n        return !value.some(function (fileItem) {\n          return fileItem.url === task.url;\n        });\n      });\n    });\n  }, [value]);\n  var idCountRef = useRef(0);\n  var maxCount = props.maxCount,\n      onPreview = props.onPreview;\n\n  function onChange(e) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var _this = this;\n\n      var rawFiles, files, exceed, newTasks;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              e.persist();\n              rawFiles = e.target.files;\n\n              if (rawFiles) {\n                _context2.next = 4;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 4:\n              files = [].slice.call(rawFiles);\n\n              if (!props.beforeUpload) {\n                _context2.next = 9;\n                break;\n              }\n\n              _context2.next = 8;\n              return props.beforeUpload(files);\n\n            case 8:\n              files = _context2.sent;\n\n            case 9:\n              if (!(files.length === 0)) {\n                _context2.next = 11;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 11:\n              if (maxCount > 0) {\n                exceed = value.length + files.length - maxCount;\n\n                if (exceed > 0) {\n                  files = files.slice(0, maxCount - exceed);\n                  (_a = props.onCountExceed) === null || _a === void 0 ? void 0 : _a.call(props, exceed);\n                }\n              }\n\n              newTasks = files.map(function (file) {\n                return {\n                  id: idCountRef.current++,\n                  status: 'pending',\n                  file: file\n                };\n              });\n              setTasks(function (prev) {\n                return [].concat(prev, newTasks);\n              });\n              _context2.next = 16;\n              return Promise.all(newTasks.map(function (currentTask) {\n                return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n                  var result;\n                  return _regeneratorRuntime.wrap(function _callee$(_context) {\n                    while (1) {\n                      switch (_context.prev = _context.next) {\n                        case 0:\n                          _context.prev = 0;\n                          _context.next = 3;\n                          return props.upload(currentTask.file);\n\n                        case 3:\n                          result = _context.sent;\n                          setTasks(function (prev) {\n                            return prev.map(function (task) {\n                              if (task.id === currentTask.id) {\n                                return Object.assign(Object.assign({}, task), {\n                                  url: result.url\n                                });\n                              }\n\n                              return task;\n                            });\n                          });\n                          updateValue(function (prev) {\n                            return [].concat(prev, [{\n                              url: result.url\n                            }]);\n                          });\n                          _context.next = 12;\n                          break;\n\n                        case 8:\n                          _context.prev = 8;\n                          _context.t0 = _context[\"catch\"](0);\n                          setTasks(function (prev) {\n                            return prev.map(function (task) {\n                              if (task.id === currentTask.id) {\n                                return Object.assign(Object.assign({}, task), {\n                                  status: 'fail'\n                                });\n                              }\n\n                              return task;\n                            });\n                          });\n                          throw _context.t0;\n\n                        case 12:\n                        case \"end\":\n                          return _context.stop();\n                      }\n                    }\n                  }, _callee, null, [[0, 8]]);\n                }));\n              }))[\"catch\"](function (error) {\n                return console.error(error);\n              });\n\n            case 16:\n              e.target.value = '';\n            // HACK: fix the same file doesn't trigger onChange\n\n            case 17:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n  }\n\n  function previewImage(index) {\n    ImageViewer.Multi.show({\n      images: value.map(function (fileItem) {\n        return fileItem.url;\n      }),\n      defaultIndex: index\n    });\n    onPreview && onPreview(index);\n  }\n\n  var showUpload = props.showUpload && (maxCount === 0 || value.length + tasks.length < maxCount);\n  return withNativeProps(props, /*#__PURE__*/React.createElement(\"div\", {\n    className: classPrefix\n  }, /*#__PURE__*/React.createElement(Space, {\n    className: classPrefix + \"-space\",\n    wrap: true\n  }, value.map(function (fileItem, index) {\n    return /*#__PURE__*/React.createElement(PreviewItem, {\n      key: fileItem.url,\n      url: fileItem.url,\n      deletable: props.deletable,\n      onClick: function onClick() {\n        return previewImage(index);\n      },\n      onDelete: function onDelete() {\n        return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n          var _a, canDelete;\n\n          return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  _context3.next = 2;\n                  return (_a = props.onDelete) === null || _a === void 0 ? void 0 : _a.call(props, fileItem);\n\n                case 2:\n                  canDelete = _context3.sent;\n\n                  if (!(canDelete === false)) {\n                    _context3.next = 5;\n                    break;\n                  }\n\n                  return _context3.abrupt(\"return\");\n\n                case 5:\n                  setValue(value.filter(function (x) {\n                    return x.url !== fileItem.url;\n                  }));\n\n                case 6:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3);\n        }));\n      }\n    });\n  }), tasks.map(function (task) {\n    return /*#__PURE__*/React.createElement(PreviewItem, {\n      key: task.id,\n      file: task.file,\n      deletable: task.status !== 'pending',\n      status: task.status,\n      onDelete: function onDelete() {\n        setTasks(tasks.filter(function (x) {\n          return x.id !== task.id;\n        }));\n      }\n    });\n  }), showUpload && /*#__PURE__*/React.createElement(\"div\", {\n    className: classPrefix + \"-upload-button-wrap\"\n  }, props.children ? props.children : /*#__PURE__*/React.createElement(\"span\", {\n    className: classPrefix + \"-cell \" + classPrefix + \"-upload-button\",\n    role: 'button'\n  }, /*#__PURE__*/React.createElement(\"span\", {\n    className: classPrefix + \"-upload-button-icon\"\n  }, /*#__PURE__*/React.createElement(AddOutline, null))), !props.disableUpload && /*#__PURE__*/React.createElement(\"input\", {\n    capture: props.capture,\n    accept: props.accept,\n    multiple: props.multiple,\n    type: 'file',\n    className: classPrefix + \"-input\",\n    onChange: onChange\n  })))));\n};","map":{"version":3,"sources":["/Users/brandonliu/Project/goairmart/antd-demo/node_modules/antd-mobile/es/components/image-uploader/image-uploader.js"],"names":["__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","React","useLayoutEffect","useRef","useState","AddOutline","mergeProps","ImageViewer","PreviewItem","usePropsValue","usePersistFn","Space","withNativeProps","classPrefix","defaultProps","disableUpload","deletable","showUpload","multiple","maxCount","defaultValue","accept","ImageUploader","p","props","_usePropsValue","setValue","updateValue","updater","_useState","tasks","setTasks","prev","filter","task","url","undefined","some","fileItem","idCountRef","onPreview","onChange","_a","mark","_callee2","_this","rawFiles","files","exceed","newTasks","wrap","_callee2$","_context2","persist","target","abrupt","slice","call","beforeUpload","sent","length","onCountExceed","map","file","id","current","status","concat","all","currentTask","_callee","_callee$","_context","upload","Object","assign","t0","stop","error","console","previewImage","index","Multi","show","images","defaultIndex","createElement","className","key","onClick","onDelete","_callee3","canDelete","_callee3$","_context3","x","children","role","capture","type"],"mappings":"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","sourcesContent":["var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport React, { useLayoutEffect, useRef, useState } from 'react';\nimport { AddOutline } from 'antd-mobile-icons';\nimport { mergeProps } from '../../utils/with-default-props';\nimport ImageViewer from '../image-viewer';\nimport PreviewItem from './preview-item';\nimport { usePropsValue } from '../../utils/use-props-value';\nimport { usePersistFn } from 'ahooks';\nimport Space from '../space';\nimport { withNativeProps } from '../../utils/native-props';\nvar classPrefix = \"adm-image-uploader\";\nvar defaultProps = {\n  disableUpload: false,\n  deletable: true,\n  showUpload: true,\n  multiple: false,\n  maxCount: 0,\n  defaultValue: [],\n  accept: 'image/*'\n};\nexport var ImageUploader = function ImageUploader(p) {\n  var props = mergeProps(defaultProps, p);\n\n  var _usePropsValue = usePropsValue(props),\n      value = _usePropsValue[0],\n      setValue = _usePropsValue[1];\n\n  var updateValue = usePersistFn(function (updater) {\n    setValue(updater(value));\n  });\n\n  var _useState = useState([]),\n      tasks = _useState[0],\n      setTasks = _useState[1];\n\n  useLayoutEffect(function () {\n    setTasks(function (prev) {\n      return prev.filter(function (task) {\n        if (task.url === undefined) return true;\n        return !value.some(function (fileItem) {\n          return fileItem.url === task.url;\n        });\n      });\n    });\n  }, [value]);\n  var idCountRef = useRef(0);\n  var maxCount = props.maxCount,\n      onPreview = props.onPreview;\n\n  function onChange(e) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n      var _this = this;\n\n      var rawFiles, files, exceed, newTasks;\n      return regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              e.persist();\n              rawFiles = e.target.files;\n\n              if (rawFiles) {\n                _context2.next = 4;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 4:\n              files = [].slice.call(rawFiles);\n\n              if (!props.beforeUpload) {\n                _context2.next = 9;\n                break;\n              }\n\n              _context2.next = 8;\n              return props.beforeUpload(files);\n\n            case 8:\n              files = _context2.sent;\n\n            case 9:\n              if (!(files.length === 0)) {\n                _context2.next = 11;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 11:\n              if (maxCount > 0) {\n                exceed = value.length + files.length - maxCount;\n\n                if (exceed > 0) {\n                  files = files.slice(0, maxCount - exceed);\n                  (_a = props.onCountExceed) === null || _a === void 0 ? void 0 : _a.call(props, exceed);\n                }\n              }\n\n              newTasks = files.map(function (file) {\n                return {\n                  id: idCountRef.current++,\n                  status: 'pending',\n                  file: file\n                };\n              });\n              setTasks(function (prev) {\n                return [].concat(prev, newTasks);\n              });\n              _context2.next = 16;\n              return Promise.all(newTasks.map(function (currentTask) {\n                return __awaiter(_this, void 0, void 0, /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n                  var result;\n                  return regeneratorRuntime.wrap(function _callee$(_context) {\n                    while (1) {\n                      switch (_context.prev = _context.next) {\n                        case 0:\n                          _context.prev = 0;\n                          _context.next = 3;\n                          return props.upload(currentTask.file);\n\n                        case 3:\n                          result = _context.sent;\n                          setTasks(function (prev) {\n                            return prev.map(function (task) {\n                              if (task.id === currentTask.id) {\n                                return Object.assign(Object.assign({}, task), {\n                                  url: result.url\n                                });\n                              }\n\n                              return task;\n                            });\n                          });\n                          updateValue(function (prev) {\n                            return [].concat(prev, [{\n                              url: result.url\n                            }]);\n                          });\n                          _context.next = 12;\n                          break;\n\n                        case 8:\n                          _context.prev = 8;\n                          _context.t0 = _context[\"catch\"](0);\n                          setTasks(function (prev) {\n                            return prev.map(function (task) {\n                              if (task.id === currentTask.id) {\n                                return Object.assign(Object.assign({}, task), {\n                                  status: 'fail'\n                                });\n                              }\n\n                              return task;\n                            });\n                          });\n                          throw _context.t0;\n\n                        case 12:\n                        case \"end\":\n                          return _context.stop();\n                      }\n                    }\n                  }, _callee, null, [[0, 8]]);\n                }));\n              }))[\"catch\"](function (error) {\n                return console.error(error);\n              });\n\n            case 16:\n              e.target.value = ''; // HACK: fix the same file doesn't trigger onChange\n\n            case 17:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n  }\n\n  function previewImage(index) {\n    ImageViewer.Multi.show({\n      images: value.map(function (fileItem) {\n        return fileItem.url;\n      }),\n      defaultIndex: index\n    });\n    onPreview && onPreview(index);\n  }\n\n  var showUpload = props.showUpload && (maxCount === 0 || value.length + tasks.length < maxCount);\n  return withNativeProps(props, /*#__PURE__*/React.createElement(\"div\", {\n    className: classPrefix\n  }, /*#__PURE__*/React.createElement(Space, {\n    className: classPrefix + \"-space\",\n    wrap: true\n  }, value.map(function (fileItem, index) {\n    return /*#__PURE__*/React.createElement(PreviewItem, {\n      key: fileItem.url,\n      url: fileItem.url,\n      deletable: props.deletable,\n      onClick: function onClick() {\n        return previewImage(index);\n      },\n      onDelete: function onDelete() {\n        return __awaiter(void 0, void 0, void 0, /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n          var _a, canDelete;\n\n          return regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  _context3.next = 2;\n                  return (_a = props.onDelete) === null || _a === void 0 ? void 0 : _a.call(props, fileItem);\n\n                case 2:\n                  canDelete = _context3.sent;\n\n                  if (!(canDelete === false)) {\n                    _context3.next = 5;\n                    break;\n                  }\n\n                  return _context3.abrupt(\"return\");\n\n                case 5:\n                  setValue(value.filter(function (x) {\n                    return x.url !== fileItem.url;\n                  }));\n\n                case 6:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3);\n        }));\n      }\n    });\n  }), tasks.map(function (task) {\n    return /*#__PURE__*/React.createElement(PreviewItem, {\n      key: task.id,\n      file: task.file,\n      deletable: task.status !== 'pending',\n      status: task.status,\n      onDelete: function onDelete() {\n        setTasks(tasks.filter(function (x) {\n          return x.id !== task.id;\n        }));\n      }\n    });\n  }), showUpload && /*#__PURE__*/React.createElement(\"div\", {\n    className: classPrefix + \"-upload-button-wrap\"\n  }, props.children ? props.children : /*#__PURE__*/React.createElement(\"span\", {\n    className: classPrefix + \"-cell \" + classPrefix + \"-upload-button\",\n    role: 'button'\n  }, /*#__PURE__*/React.createElement(\"span\", {\n    className: classPrefix + \"-upload-button-icon\"\n  }, /*#__PURE__*/React.createElement(AddOutline, null))), !props.disableUpload && /*#__PURE__*/React.createElement(\"input\", {\n    capture: props.capture,\n    accept: props.accept,\n    multiple: props.multiple,\n    type: 'file',\n    className: classPrefix + \"-input\",\n    onChange: onChange\n  })))));\n};"]},"metadata":{},"sourceType":"module"}