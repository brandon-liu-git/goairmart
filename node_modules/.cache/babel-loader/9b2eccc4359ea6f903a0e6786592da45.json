{"ast":null,"code":"var __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) {\n      ar.push(r.value);\n    }\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) {\n    ar = ar.concat(__read(arguments[i]));\n  }\n\n  return ar;\n};\n\nimport useRequest from '@ahooksjs/use-request';\nimport { useState, useCallback, useEffect, useRef } from 'react';\nimport useUpdateEffect from '../useUpdateEffect';\nimport usePersistFn from '../usePersistFn';\n\nfunction useAntdTable(service, options) {\n  var form = options.form,\n      _a = options.refreshDeps,\n      refreshDeps = _a === void 0 ? [] : _a,\n      manual = options.manual,\n      _b = options.defaultType,\n      defaultType = _b === void 0 ? 'simple' : _b,\n      defaultParams = options.defaultParams,\n      restOptions = __rest(options, [\"form\", \"refreshDeps\", \"manual\", \"defaultType\", \"defaultParams\"]);\n\n  var result = useRequest(service, __assign(__assign({}, restOptions), {\n    paginated: true,\n    manual: true\n  }));\n  var params = result.params,\n      run = result.run;\n  var cacheFormTableData = params[2] || {}; // 优先从缓存中读\n\n  var _c = __read(useState(cacheFormTableData.type || defaultType), 2),\n      type = _c[0],\n      setType = _c[1]; // 全量 form 数据，包括 simple 和 advance\n\n\n  var _d = __read(useState(cacheFormTableData.allFormData || defaultParams && defaultParams[1] || {}), 2),\n      allFormData = _d[0],\n      setAllFormData = _d[1]; // 获取当前展示的 form 字段值\n\n\n  var getActivetFieldValues = useCallback(function () {\n    if (!form) {\n      return {};\n    } // antd 3\n\n\n    if (form.getFieldInstance) {\n      var tempAllFiledsValue_1 = form.getFieldsValue();\n      var filterFiledsValue_1 = {};\n      Object.keys(tempAllFiledsValue_1).forEach(function (key) {\n        if (form.getFieldInstance ? form.getFieldInstance(key) : true) {\n          filterFiledsValue_1[key] = tempAllFiledsValue_1[key];\n        }\n      });\n      return filterFiledsValue_1;\n    } // antd 4\n\n\n    return form.getFieldsValue(null, function () {\n      return true;\n    });\n  }, [form]);\n  var formRef = useRef(form);\n  formRef.current = form;\n  /* 初始化，或改变了 searchType, 恢复表单数据 */\n\n  useEffect(function () {\n    if (!formRef.current) {\n      return;\n    } // antd 3\n\n\n    if (formRef.current.getFieldInstance) {\n      // antd 3 需要判断字段是否存在，否则会抛警告\n      var filterFiledsValue_2 = {};\n      Object.keys(allFormData).forEach(function (key) {\n        if (formRef.current.getFieldInstance ? formRef.current.getFieldInstance(key) : true) {\n          filterFiledsValue_2[key] = allFormData[key];\n        }\n      });\n      formRef.current.setFieldsValue(filterFiledsValue_2);\n    } else {\n      // antd 4\n      formRef.current.setFieldsValue(allFormData);\n    }\n  }, [type]); // 首次加载，手动提交。为了拿到 form 的 initial values\n\n  useEffect(function () {\n    // 如果有缓存，则使用缓存，重新请求\n    if (params.length > 0) {\n      run.apply(void 0, __spread(params));\n      return;\n    } // 如果没有缓存，触发 submit\n\n\n    if (!manual) {\n      _submit(defaultParams);\n    }\n  }, []);\n  var changeType = useCallback(function () {\n    var currentFormData = getActivetFieldValues();\n    setAllFormData(__assign(__assign({}, allFormData), currentFormData));\n    var targetType = type === 'simple' ? 'advance' : 'simple';\n    setType(targetType);\n  }, [type, allFormData, getActivetFieldValues]);\n  var validateFields = useCallback(function () {\n    var fieldValues = getActivetFieldValues();\n\n    if (!form) {\n      return Promise.resolve();\n    }\n\n    var fields = Object.keys(fieldValues);\n\n    if (!form.getInternalHooks) {\n      return new Promise(function (resolve, reject) {\n        form.validateFields(fields, function (errors, values) {\n          if (errors) {\n            reject(errors);\n          } else {\n            resolve(values);\n          }\n        });\n      });\n    }\n\n    return form.validateFields(fields);\n  }, [form]);\n\n  var _submit = useCallback(function (initParams) {\n    setTimeout(function () {\n      validateFields().then(function () {\n        var activeFormData = getActivetFieldValues(); // 记录全量数据\n\n        var _allFormData = __assign(__assign({}, allFormData), activeFormData);\n\n        setAllFormData(_allFormData); // has defaultParams\n\n        if (initParams) {\n          run(initParams[0], activeFormData, {\n            allFormData: _allFormData,\n            type: type\n          });\n          return;\n        }\n\n        run(__assign(__assign({\n          pageSize: options.defaultPageSize || 10\n        }, params[0] || {}), {\n          current: 1\n        }), activeFormData, {\n          allFormData: _allFormData,\n          type: type\n        });\n      })[\"catch\"](function (err) {\n        return err;\n      });\n    });\n  }, [getActivetFieldValues, run, params, allFormData, type]);\n\n  var reset = useCallback(function () {\n    if (form) {\n      form.resetFields();\n    }\n\n    _submit();\n  }, [form, _submit]);\n  var resetPersistFn = usePersistFn(reset); // refreshDeps 变化，reset。\n\n  useUpdateEffect(function () {\n    if (!manual) {\n      resetPersistFn();\n    }\n  }, __spread(refreshDeps));\n  var submit = usePersistFn(function (e) {\n    if (e && e.preventDefault) {\n      e.preventDefault();\n    }\n\n    _submit();\n  });\n  return __assign(__assign({}, result), {\n    search: {\n      submit: submit,\n      type: type,\n      changeType: changeType,\n      reset: reset\n    }\n  });\n}\n\nexport default useAntdTable;","map":{"version":3,"sources":["/Users/brandonliu/Project/goairmart/antd-demo/node_modules/ahooks/es/useAntdTable/index.js"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__rest","e","indexOf","getOwnPropertySymbols","propertyIsEnumerable","__read","o","m","Symbol","iterator","r","ar","next","done","push","value","error","__spread","concat","useRequest","useState","useCallback","useEffect","useRef","useUpdateEffect","usePersistFn","useAntdTable","service","options","form","_a","refreshDeps","manual","_b","defaultType","defaultParams","restOptions","result","paginated","params","run","cacheFormTableData","_c","type","setType","_d","allFormData","setAllFormData","getActivetFieldValues","getFieldInstance","tempAllFiledsValue_1","getFieldsValue","filterFiledsValue_1","keys","forEach","key","formRef","current","filterFiledsValue_2","setFieldsValue","_submit","changeType","currentFormData","targetType","validateFields","fieldValues","Promise","resolve","fields","getInternalHooks","reject","errors","values","initParams","setTimeout","then","activeFormData","_allFormData","pageSize","defaultPageSize","err","reset","resetFields","resetPersistFn","submit","preventDefault","search"],"mappings":"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","sourcesContent":["var __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) {\n      ar.push(r.value);\n    }\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar __spread = this && this.__spread || function () {\n  for (var ar = [], i = 0; i < arguments.length; i++) {\n    ar = ar.concat(__read(arguments[i]));\n  }\n\n  return ar;\n};\n\nimport useRequest from '@ahooksjs/use-request';\nimport { useState, useCallback, useEffect, useRef } from 'react';\nimport useUpdateEffect from '../useUpdateEffect';\nimport usePersistFn from '../usePersistFn';\n\nfunction useAntdTable(service, options) {\n  var form = options.form,\n      _a = options.refreshDeps,\n      refreshDeps = _a === void 0 ? [] : _a,\n      manual = options.manual,\n      _b = options.defaultType,\n      defaultType = _b === void 0 ? 'simple' : _b,\n      defaultParams = options.defaultParams,\n      restOptions = __rest(options, [\"form\", \"refreshDeps\", \"manual\", \"defaultType\", \"defaultParams\"]);\n\n  var result = useRequest(service, __assign(__assign({}, restOptions), {\n    paginated: true,\n    manual: true\n  }));\n  var params = result.params,\n      run = result.run;\n  var cacheFormTableData = params[2] || {}; // 优先从缓存中读\n\n  var _c = __read(useState(cacheFormTableData.type || defaultType), 2),\n      type = _c[0],\n      setType = _c[1]; // 全量 form 数据，包括 simple 和 advance\n\n\n  var _d = __read(useState(cacheFormTableData.allFormData || defaultParams && defaultParams[1] || {}), 2),\n      allFormData = _d[0],\n      setAllFormData = _d[1]; // 获取当前展示的 form 字段值\n\n\n  var getActivetFieldValues = useCallback(function () {\n    if (!form) {\n      return {};\n    } // antd 3\n\n\n    if (form.getFieldInstance) {\n      var tempAllFiledsValue_1 = form.getFieldsValue();\n      var filterFiledsValue_1 = {};\n      Object.keys(tempAllFiledsValue_1).forEach(function (key) {\n        if (form.getFieldInstance ? form.getFieldInstance(key) : true) {\n          filterFiledsValue_1[key] = tempAllFiledsValue_1[key];\n        }\n      });\n      return filterFiledsValue_1;\n    } // antd 4\n\n\n    return form.getFieldsValue(null, function () {\n      return true;\n    });\n  }, [form]);\n  var formRef = useRef(form);\n  formRef.current = form;\n  /* 初始化，或改变了 searchType, 恢复表单数据 */\n\n  useEffect(function () {\n    if (!formRef.current) {\n      return;\n    } // antd 3\n\n\n    if (formRef.current.getFieldInstance) {\n      // antd 3 需要判断字段是否存在，否则会抛警告\n      var filterFiledsValue_2 = {};\n      Object.keys(allFormData).forEach(function (key) {\n        if (formRef.current.getFieldInstance ? formRef.current.getFieldInstance(key) : true) {\n          filterFiledsValue_2[key] = allFormData[key];\n        }\n      });\n      formRef.current.setFieldsValue(filterFiledsValue_2);\n    } else {\n      // antd 4\n      formRef.current.setFieldsValue(allFormData);\n    }\n  }, [type]); // 首次加载，手动提交。为了拿到 form 的 initial values\n\n  useEffect(function () {\n    // 如果有缓存，则使用缓存，重新请求\n    if (params.length > 0) {\n      run.apply(void 0, __spread(params));\n      return;\n    } // 如果没有缓存，触发 submit\n\n\n    if (!manual) {\n      _submit(defaultParams);\n    }\n  }, []);\n  var changeType = useCallback(function () {\n    var currentFormData = getActivetFieldValues();\n    setAllFormData(__assign(__assign({}, allFormData), currentFormData));\n    var targetType = type === 'simple' ? 'advance' : 'simple';\n    setType(targetType);\n  }, [type, allFormData, getActivetFieldValues]);\n  var validateFields = useCallback(function () {\n    var fieldValues = getActivetFieldValues();\n\n    if (!form) {\n      return Promise.resolve();\n    }\n\n    var fields = Object.keys(fieldValues);\n\n    if (!form.getInternalHooks) {\n      return new Promise(function (resolve, reject) {\n        form.validateFields(fields, function (errors, values) {\n          if (errors) {\n            reject(errors);\n          } else {\n            resolve(values);\n          }\n        });\n      });\n    }\n\n    return form.validateFields(fields);\n  }, [form]);\n\n  var _submit = useCallback(function (initParams) {\n    setTimeout(function () {\n      validateFields().then(function () {\n        var activeFormData = getActivetFieldValues(); // 记录全量数据\n\n        var _allFormData = __assign(__assign({}, allFormData), activeFormData);\n\n        setAllFormData(_allFormData); // has defaultParams\n\n        if (initParams) {\n          run(initParams[0], activeFormData, {\n            allFormData: _allFormData,\n            type: type\n          });\n          return;\n        }\n\n        run(__assign(__assign({\n          pageSize: options.defaultPageSize || 10\n        }, params[0] || {}), {\n          current: 1\n        }), activeFormData, {\n          allFormData: _allFormData,\n          type: type\n        });\n      })[\"catch\"](function (err) {\n        return err;\n      });\n    });\n  }, [getActivetFieldValues, run, params, allFormData, type]);\n\n  var reset = useCallback(function () {\n    if (form) {\n      form.resetFields();\n    }\n\n    _submit();\n  }, [form, _submit]);\n  var resetPersistFn = usePersistFn(reset); // refreshDeps 变化，reset。\n\n  useUpdateEffect(function () {\n    if (!manual) {\n      resetPersistFn();\n    }\n  }, __spread(refreshDeps));\n  var submit = usePersistFn(function (e) {\n    if (e && e.preventDefault) {\n      e.preventDefault();\n    }\n\n    _submit();\n  });\n  return __assign(__assign({}, result), {\n    search: {\n      submit: submit,\n      type: type,\n      changeType: changeType,\n      reset: reset\n    }\n  });\n}\n\nexport default useAntdTable;"]},"metadata":{},"sourceType":"module"}